import asyncio
import time
import json
import os
from openai import OpenAI
from config import API_KEY, MODELS

# —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞ static/prompt.json
def load_prompt():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –∏–∑ —Ñ–∞–π–ª–∞"""
    try:
        # –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        current_dir = os.path.dirname(os.path.abspath(__file__))
        prompt_path = os.path.join(current_dir, "static", "prompt.json")
        
        # —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        with open(prompt_path, "r", encoding="utf-8") as f:
            data = json.load(f)
            return data.get("system_prompt", "–¢—ã ‚Äî –≥–∞–¥–∞–ª–∫–∞. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º.")
    except:
        # –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        return "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω–∞—è –≥–∞–¥–∞–ª–∫–∞. –ì–µ–Ω–µ—Ä–∏—Ä—É–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º."

# –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é SYSTEM_PROMPT
SYSTEM_PROMPT = load_prompt()

# —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ OpenAI —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º API-–∫–ª—é—á–∞
client = OpenAI(
    base_url="https://router.huggingface.co/v1",
    api_key=API_KEY
)

# –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é GPT
async def gpt_generation(
    user_prompt: str,                                                       # –ø—Ä–æ–º–ø—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
    temperature: float = 0.7,                                               # —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.7)
    max_tokens: int = 2500,                                                 # –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2500)
    zodiac: str = None,                                                     # –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞
    divination_type: str = None,                                            # —Ç–∏–ø –≥–∞–¥–∞–Ω–∏—è 
    retry_attempts: int = 2                                                 # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
) -> str:
    
    # —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –≤–∫–ª—é—á–∞—è –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    full_prompt = ""
    if zodiac:
        full_prompt += f"–ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞: {zodiac}\n"                          # –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–Ω–∞–∫–µ –∑–æ–¥–∏–∞–∫–∞
    if divination_type:                                                     
        full_prompt += f"–¢–∏–ø –≥–∞–¥–∞–Ω–∏—è: {divination_type}\n"                  # –¥–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –≥–∞–¥–∞–Ω–∏—è
    full_prompt += f"\n{user_prompt}"                                       # –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    # –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã –æ–Ω–∞ –æ—Ç–≤–µ—á–∞–ª–∞ –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
    full_prompt += "\n\n–í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç—å –ø–æ–ª–Ω—ã–º, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—Ä–æ–µ—Ç–æ—á–∏–µ '...' –∫–∞–∫ –æ—Ç–≤–µ—Ç."
    
    # —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ API
    messages = [
        {"role": "system", "content": SYSTEM_PROMPT},                       # —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
        {"role": "user", "content": full_prompt}                            # —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∑–∞–ø—Ä–æ—Å–æ–º
    ]
    
    model_name = MODELS["gpt"]["model_name"]                                # –ø–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    
    # –ª–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞
    print(f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ GPT...")
    print(f"   –ú–æ–¥–µ–ª—å: {model_name}")
    print(f"   –ü—Ä–æ–º–ø—Ç: {full_prompt[:300]}...")

    # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    attempt = 0
    while attempt < retry_attempts:
        try:
            start = time.time()                                              # –∑–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
            # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            response = await asyncio.to_thread(
                lambda: client.chat.completions.create(
                    model=model_name,
                    messages=messages,
                    temperature=temperature,
                    max_tokens=max_tokens,
                )
            )
            
            elapsed = time.time() - start                                    # —Å—á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
            print(f"‚úÖ GPT –æ—Ç–≤–µ—Ç –∑–∞ {elapsed:.1f} —Å–µ–∫")
            
            result = response.choices[0].message.content.strip()             # –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –º–æ–¥–µ–ª–∏
            print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç (–ø–µ—Ä–≤—ã–µ 150 —Å–∏–º–≤–æ–ª–æ–≤): {result[:250]}")     # –ª–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 250 —Å–∏–º–≤–æ–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

            
            # –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø—É—Å—Ç—ã–µ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
            if (not result or 
                result.strip() == "" or 
                result.startswith("...") or 
                len(result.split()) < 10):  # –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –º–µ–Ω—å—à–µ 10 —Å–ª–æ–≤
                
                print(f"‚ö†Ô∏è  –ü–æ–ª—É—á–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–Ω–æ–≤–æ —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏")
                
                # –ø—Ä–æ–±—É–µ–º —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–ø–æ–≤—ã—à–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É)
                attempt += 1
                temperature = min(temperature + 0.2, 1.0)                     # –ø–æ–≤—ã—à–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É
                continue  # –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —Å–Ω–æ–≤–∞
            return result
        
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ GPT API: {e}")                                 # –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            raise e

    # –µ—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return "üåÄ –£–ø—Å... –∑–≤—ë–∑–¥—ã —Å–µ–≥–æ–¥–Ω—è –∫–∞–ø—Ä–∏–∑–Ω–∏—á–∞—é—Ç. –ü–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑?"

# –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –¥—Ä—É–≥–∏–º–∏ —á–∞—Å—Ç—è–º–∏ —Å–∏—Å—Ç–µ–º—ã
async def generate_gpt_prediction(prompt, **kwargs):
    return await gpt_generation(prompt, **kwargs)                            # –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
